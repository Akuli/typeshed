name: Comment with mypy_primer diff

on:
  # pull_request_target gives us access to a write token which we need to post a comment
  # The presence of a write token means that we can't run any untrusted code (i.e. malicious PRs),
  # which is why this its own workflow. Github Actions doesn't make it easy for workflows to talk to
  # each other, so the approach here is to poll for workflow runs, find the mypy_primer run for our
  # commit, wait till it's completed, and download and post the diff.
  pull_request_target:

permissions:
  contents: read
  pull-requests: write

jobs:
  mypy_primer:
    name: Comment
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: npm install adm-zip
      - name: Post comment
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            await github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Hello',
            })

      - uses: kanga333/comment-hider@v0.2.1
        name: Hide old comments
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          leave_visible: 1
